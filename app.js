"use strict";window.__APP_VERSION__="MF_KERNEL_JOULE_v6_2026-02-20";console.log("[Millennium Falcon] app.js loaded:",window.__APP_VERSION__);const KERNEL_MODE="SQRT";const CONST={ML_UNIV:0.51,ASTAR:1.5e-10,KPC_TO_M:3.085677581491367e19,KMPS_TO_MPS:1000,};const $=(id)=>document.getElementById(id);const el={tau:$("tau"),astarOverride:$("astarOverride"),zipStatus:$("zipStatus"),sparcFile:$("sparcFile"),galaxySelect:$("galaxySelect"),btnRunGalaxy:$("btnRunGalaxy"),btnPNG:$("btnPNG"),btnCSV:$("btnCSV"),btnReset:$("btnReset"),btnGlobalRMS:$("btnGlobalRMS"),btnGlobalCSV:$("btnGlobalCSV"),globalOut:$("globalOut"),btnRunDwarfs:$("btnRunDwarfs"),dwarfFile:$("dwarfFile"),dwarfsOut:$("dwarfsOut"),btnDwarfsCSV:$("btnDwarfsCSV"),btnDwarfsPNG:$("btnDwarfsPNG"),kpiGalaxy:$("kpiGalaxy"),kpiRMS:$("kpiRMS"),kpiAstar:$("kpiAstar"),plotSparc:$("plotSparc"),plotGlobal:$("plotGlobal"),plotDwarfs:$("plotDwarfs"),viewSparc:$("view-sparc"),viewGlobal:$("view-global"),viewDwarfs:$("view-dwarfs"),viewDownloads:$("view-downloads"),viewLocuss:$("view-locuss"),btnRunLocuss:$("btnRunLocuss"),clusterSelect:$("clusterSelect"),locussOut:$("locussOut"),plotLocuss:$("plotLocuss"),btnLocussGlobal:$("btnLocussGlobal"),btnLocussCSV:$("btnLocussCSV"),btnLocussPNG:$("btnLocussPNG"),locussEps:$("locussEps"),locussAstar:$("locussAstar"),perfOut:$("perfOut"),btnBTFR:$("btnBTFR"),};function assetCandidates(filename){const origin=window.location.origin;const path=window.location.pathname;const base=path.endsWith("/")? path:path.slice(0,path.lastIndexOf("/")+1);const repoBase=origin+base;const rootBase=origin+"/";return [ "./"+filename,filename,repoBase+filename,rootBase+filename ];}const state={zip:null,files:[],galaxies:[],currentGalaxy:null,currentRows:null,lastCSV:null,lastPNGTarget:null,};function clamp(x,a,b){return Math.max(a,Math.min(b,x));}function safeNum(x){const v=Number(x);return Number.isFinite(v)? v:NaN;}function rms(arr){let s=0,n=0;for(const v of arr){if(Number.isFinite(v)){s+=v*v;n++;}}return n ? Math.sqrt(s/n):NaN;}function vbar2_km2s2(row){const vgas=row.Vgas;const vdisk=row.Vdisk;const vbul=row.Vbul;if(![vgas,vdisk,vbul].every(Number.isFinite))return NaN;return vgas*vgas+CONST.ML_UNIV*(vdisk*vdisk+vbul*vbul);}function aN_mps2(row){const vb2=vbar2_km2s2(row);const r_m=row.R_kpc*CONST.KPC_TO_M;if(!Number.isFinite(vb2)|| !(r_m>0))return NaN;const vb2_m2s2=vb2*(CONST.KMPS_TO_MPS**2);return vb2_m2s2/r_m;}function aKernel_mps2(aN,aStar){if(!(aN>0)|| !(aStar>0))return 0;if(KERNEL_MODE==="OHM_HALF"){return 0.5*(aN+Math.sqrt(aN*aN+4*aN*aStar));}return Math.sqrt(aN*aN+aN*aStar);}function coherenceCamB(row,aN,aStar){const vb2=vbar2_km2s2(row);const fg=(Number.isFinite(vb2)&& vb2>0)? clamp((row.Vgas*row.Vgas)/vb2,0,1):0;const x=(aN>0)?(aStar/aN):1e6;const alpha=7.5;const beta=0.65;const C=1/(1+alpha*fg*Math.pow(x,beta));return clamp(C,0.08,1.0);}function isCamBName(name){return/^camb/i.test(String(name || ""));}function getAstar(){const user=safeNum(el.astarOverride?.value);return(Number.isFinite(user)&& user>0)? user:CONST.ASTAR;}function parseRotmodText(text){const lines=String(text).split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith("#"));if(!lines.length)return [];const first=lines[0];const hasLetters=/[A-Za-z]/.test(first);let start=0;let header=null;if(hasLetters){header=first.split(/[\s,]+/).map(s=>s.trim());start=1;}const rows=[];for(let i=start;i<lines.length;i++){const parts=lines[i].split(/[\s,]+/);if(parts.length<4)continue;let R_kpc,Vobs,eVobs,Vgas,Vdisk,Vbul;if(header){const idx=(name)=>header.findIndex(h=>h.toLowerCase()===name.toLowerCase());const pick=(name,fallbackIdx)=>{const j=idx(name);return safeNum(parts[(j>=0)? j:fallbackIdx]);};R_kpc=pick("R",0);Vobs=pick("Vobs",1);eVobs=pick("eVobs",2);Vgas=pick("Vgas",3);Vdisk=pick("Vdisk",4);Vbul=pick("Vbul",5);}else{R_kpc=safeNum(parts[0]);Vobs=safeNum(parts[1]);eVobs=safeNum(parts[2]);Vgas=safeNum(parts[3]);Vdisk=safeNum(parts[4]);Vbul=safeNum(parts[5]);}if(!Number.isFinite(R_kpc)|| !Number.isFinite(Vobs))continue;rows.push({R_kpc,Vobs,eVobs:Number.isFinite(eVobs)? eVobs:NaN,Vgas:Number.isFinite(Vgas)? Vgas:0,Vdisk:Number.isFinite(Vdisk)? Vdisk:0,Vbul:Number.isFinite(Vbul)? Vbul:0,});}return rows;}function computePrediction(galaxyName,rows){const aStar=getAstar();el.kpiAstar &&(el.kpiAstar.textContent=aStar.toExponential(3));const out=[];const residuals=[];for(const row of rows){const aN=aN_mps2(row);let aEff=aKernel_mps2(aN,aStar);if(isCamBName(galaxyName)){const C=coherenceCamB(row,aN,aStar);aEff*=C;}const r_m=row.R_kpc*CONST.KPC_TO_M;const vpred_mps=Math.sqrt(Math.max(0,r_m*aEff));const vpred=vpred_mps/CONST.KMPS_TO_MPS;out.push({R_kpc:row.R_kpc,Vobs:row.Vobs,eVobs:row.eVobs,Vgas:row.Vgas,Vdisk:row.Vdisk,Vbul:row.Vbul,Vpred:vpred,aN_mps2:aN,aEff_mps2:aEff,});if(Number.isFinite(row.Vobs)&& Number.isFinite(vpred)){residuals.push(vpred-row.Vobs);}}const RMS=rms(residuals);return{table:out,RMS};}function plotGalaxy(galaxyName,table){const x=table.map(r=>r.R_kpc);const yObs=table.map(r=>r.Vobs);const yPred=table.map(r=>r.Vpred);const data=[{x,y:yObs,mode:"markers",name:"Observed"},{x,y:yPred,mode:"lines",name:"Predicted"},];const layout={title:galaxyName,xaxis:{title:"r(kpc)"},yaxis:{title:"V(km/s)"},margin:{l:50,r:20,t:50,b:45},paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:"rgba(240,246,255,.92)"},legend:{orientation:"h"},};Plotly.newPlot(el.plotSparc,data,layout,{responsive:true,displaylogo:false});state.lastPNGTarget="plotSparc";}function plotGlobalRMS(points){const x=points.map(p=>p.RMS);const y=points.map(p=>p.name);const data=[{x,y,type:"bar",orientation:"h",name:"RMS"}];const layout={title:"Global RMS(all galaxies)",xaxis:{title:"RMS(km/s)"},margin:{l:140,r:20,t:50,b:45},paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:"rgba(240,246,255,.92)"},};Plotly.newPlot(el.plotGlobal,data,layout,{responsive:true,displaylogo:false});state.lastPNGTarget="plotGlobal";}function downloadText(filename,text){const blob=new Blob([text],{type:"text/plain;charset=utf-8"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}function toCSV(table){const cols=["R_kpc","Vobs","eVobs","Vgas","Vdisk","Vbul","Vpred","aN_mps2","aEff_mps2"];const lines=[cols.join(",")];for(const r of table){lines.push(cols.map(c=>(r[c] ?? "")).join(","));}return lines.join("\n");}async function downloadPNG(plotId){const div=$(plotId);if(!div)return;const dataUrl=await Plotly.toImage(div,{format:"png",height:700,width:1100});const a=document.createElement("a");a.href=dataUrl;a.download=`${state.currentGalaxy || "plot"}.png`;document.body.appendChild(a);a.click();a.remove();}async function fetchArrayBuffer(url){const res=await fetch(url,{cache:"no-store"});if(!res.ok)throw new Error(`Fetch failed ${res.status}for ${url}`);return await res.arrayBuffer();}async function loadZipFromArrayBuffer(ab,sourceLabel){const zip=await JSZip.loadAsync(ab);state.zip=zip;const files=[];zip.forEach((path,entry)=>{if(!entry.dir &&/\.csv$/i.test(path))files.push({name:path,entry});});state.files=files;state.galaxies=files .map(f=>f.name).map(name=>name.split("/").pop()).filter(name=>/_rotmod\.(csv|dat)$/i.test(name)).sort((a,b)=>a.localeCompare(b));populateGalaxySelect();el.zipStatus &&(el.zipStatus.textContent=`SPARC listo:${state.galaxies.length}galaxias(${sourceLabel}).`);if(el.btnGlobalRMS)el.btnGlobalRMS.disabled=false;if(el.btnRunGalaxy)el.btnRunGalaxy.disabled=false;}async function loadZipFromRepo(){const path=window.location.pathname || "/";const base=path.endsWith("/")? path:path.replace(/[^\/]+$/,"");const candidates=[ "./Rotmod_LTG.zip","Rotmod_LTG.zip",base+"Rotmod_LTG.zip","/Rotmod_LTG.zip" ];if(el.btnLoadZip)el.btnLoadZip.disabled=false;el.zipStatus &&(el.zipStatus.textContent="Loading SPARC database…");let lastErr=null;for(const url of candidates){try{const ab=await fetchArrayBuffer(url);await loadZipFromArrayBuffer(ab,"repo");el.zipStatus &&(el.zipStatus.textContent="SPARC DB loaded.");return;}catch(e){lastErr=e;}}console.warn("[SPARC] Auto-load failed:",candidates,lastErr);el.zipStatus &&(el.zipStatus.textContent="SPARC DB missing(Rotmod_LTG.zip). Click here or use Load ZIP.");if(el.zipStatus && !el.zipStatus.__zip_click){el.zipStatus.style.cursor="pointer";el.zipStatus.__zip_click=true;el.zipStatus.addEventListener("click",()=>el.sparcFile && el.sparcFile.click());}}async function readGalaxyCSV(galaxyName){const match=state.files.find(f=>f.name.toLowerCase().endsWith(`/${galaxyName.toLowerCase()}.csv`)|| f.name.toLowerCase().endsWith(`${galaxyName.toLowerCase()}.csv`));if(!match)throw new Error(`Galaxy not found in ZIP:${galaxyName}`);const txt=await match.entry.async("string");return parseRotmodText(txt);}async function runSelectedGalaxy(){try{const name=el.galaxySelect.value;state.currentGalaxy=name;el.kpiGalaxy &&(el.kpiGalaxy.textContent=name);const rows=await readGalaxyCSV(name);state.currentRows=rows;const{table,RMS}=computePrediction(name,rows);state.lastCSV=toCSV(table);el.kpiRMS &&(el.kpiRMS.textContent=Number.isFinite(RMS)? RMS.toFixed(2):"—");plotGalaxy(name,table);el.btnCSV.disabled=false;el.btnPNG.disabled=false;}catch(err){console.error(err);alert(`Run failed:${err.message || err}`);}}async function runGlobalRMS(){try{el.globalOut &&(el.globalOut.textContent="Computing global RMS...");const points=[];for(const name of state.galaxies){const rows=await readGalaxyCSV(name);const{RMS}=computePrediction(name,rows);points.push({name,RMS});}points.sort((a,b)=>(b.RMS||0)-(a.RMS||0));plotGlobalRMS(points);const csv=["name,RMS_km_s"].concat(points.map(p=>`${p.name},${p.RMS}`)).join("\n");state.lastGlobalCSV=csv;el.btnGlobalCSV.disabled=false;el.globalOut &&(el.globalOut.textContent=`Done. Worst RMS:${points[0].name}=${points[0].RMS.toFixed(2)}km/s`);}catch(err){console.error(err);alert(`Global RMS failed:${err.message || err}`);}}function isDwarfName(name){const s=String(name || "").toLowerCase();return s.startsWith("camb")|| s.includes("draco")|| s.includes("ursa")|| s.includes("sextans")|| s.includes("carina")|| s.includes("fornax")|| s.includes("sculptor")|| s.includes("leo");}async function runDwarfs(){try{el.dwarfsOut &&(el.dwarfsOut.textContent="Running dwarf set...");const dwarfs=state.galaxies.filter(isDwarfName);const points=[];for(const name of dwarfs){const rows=await readGalaxyCSV(name);const{RMS}=computePrediction(name,rows);points.push({name,RMS});}points.sort((a,b)=>(b.RMS||0)-(a.RMS||0));const x=points.map(p=>p.RMS);const y=points.map(p=>p.name);Plotly.newPlot(el.plotDwarfs,[{x,y,type:"bar",orientation:"h",name:"RMS"}],{title:"Dwarfs RMS",xaxis:{title:"RMS(km/s)"},margin:{l:140,r:20,t:50,b:45},paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:"rgba(240,246,255,.92)"},},{responsive:true,displaylogo:false});state.lastDwarfsCSV=["name,RMS_km_s"].concat(points.map(p=>`${p.name},${p.RMS}`)).join("\n");el.btnDwarfsCSV.disabled=false;el.btnDwarfsPNG.disabled=false;el.dwarfsOut &&(el.dwarfsOut.textContent=`Done. N=${points.length}`);}catch(err){console.error(err);alert(`Dwarfs failed:${err.message || err}`);}}function wire(){if(el.btnRunGalaxy)el.btnRunGalaxy.disabled=true;if(el.btnGlobalRMS)el.btnGlobalRMS.disabled=true;if(el.btnCSV)el.btnCSV.disabled=true;if(el.btnPNG)el.btnPNG.disabled=true;if(el.btnGlobalCSV)el.btnGlobalCSV.disabled=true;if(el.btnDwarfsCSV)el.btnDwarfsCSV.disabled=true;if(el.btnDwarfsPNG)el.btnDwarfsPNG.disabled=true;el.btnRunGalaxy?.addEventListener("click",runSelectedGalaxy);el.btnGlobalRMS?.addEventListener("click",runGlobalRMS);el.btnCSV?.addEventListener("click",()=>{if(!state.lastCSV)return;downloadText(`${state.currentGalaxy || "galaxy"}_pred.csv`,state.lastCSV);});el.btnPNG?.addEventListener("click",()=>{if(!state.lastPNGTarget)return;downloadPNG(state.lastPNGTarget);});el.btnGlobalCSV?.addEventListener("click",()=>{if(!state.lastGlobalCSV)return;downloadText(`global_rms.csv`,state.lastGlobalCSV);});el.btnRunDwarfs?.addEventListener("click",runDwarfs);el.btnDwarfsCSV?.addEventListener("click",()=>{if(!state.lastDwarfsCSV)return;downloadText("dwarfs_rms.csv",state.lastDwarfsCSV);});el.btnDwarfsPNG?.addEventListener("click",()=>downloadPNG("plotDwarfs"));el.btnReset?.addEventListener("click",()=>location.reload());el.btnRunLocuss?.addEventListener("click",()=>{el.locussOut &&(el.locussOut.textContent="LoCuSS module is not modified by this clean build.");});loadZipFromRepo().catch(err=>{console.error(err);el.zipStatus &&(el.zipStatus.textContent=`ERROR loading Rotmod_LTG.zip:${err.message || err}`);alert(`ERROR:Could not load Rotmod_LTG.zip.\nMake sure the ZIP is in the repo root.\n\n${err.message || err}`);});}document.addEventListener("DOMContentLoaded",wire);if(el.sparcFile && !el.sparcFile.__zip_change){el.sparcFile.__zip_change=true;el.sparcFile.addEventListener("change",async(ev)=>{const f=ev.target.files && ev.target.files[0];if(!f)return;try{el.zipStatus &&(el.zipStatus.textContent="Cargando ZIP local...");const ab=await f.arrayBuffer();await loadZipFromArrayBuffer(ab,"local");}catch(err){console.error("[SPARC] ZIP local error:",err);el.zipStatus &&(el.zipStatus.textContent="Error leyendo el ZIP local.");}finally{try{el.sparcFile.value="";}catch(e){}}});}